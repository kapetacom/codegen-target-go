// #FILENAME:main.go:merge
package main

import (
{{#provides 'kapeta/resource-type-rest-api'}}
    "github.com/labstack/echo/v4"
"{{@root.options.basePackage}}/generated"
    kapeta "github.com/kapetacom/sdk-go-config"
{{/provides}}
{{#consumers-of-type 'kapeta/resource-type-auth-jwt-consumer'}}
        "{{@root.options.basePackage}}/generated/auth"
{{/consumers-of-type}}
)

func main() {
    e := echo.New()

    config, err := kapeta.Init(".")
    if err != nil {
        panic(err)
    }
    port, err := config.GetServerPort("rest")
    if err != nil {
        panic(err)
    }

    host, err := config.GetServerHost()
    if err != nil {
        panic(err)
    }

    {{#consumers-of-type 'kapeta/resource-type-auth-jwt-consumer'}}
    e.Use(auth.AddJWTMiddleware(config)...)
    {{/consumers-of-type}}

    generated.RegisterRouters(e, config)

    // Start the server and log if it fails
    e.Logger.Debug("Starting server on port " + port)
    e.Logger.Fatal(e.Start(host + ":"+port))
}
